<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wikipedia objects</title>
  <script src="js/jquery-2.2.1.min.js"></script>
  <script src="js/lodash.js"></script>
  <script src="https://cdn.rawgit.com/maxlath/wikidata-sdk/master/dist/wikidata-sdk.min.js"></script>
</head>
<body>
 
<pre id='json' style='white-space: pre-wrap'></pre>
 
<script>


(function() {

	/*

	==========
	wikipedia

	-> all the sections within an article
	https://en.wikipedia.org/w/api.php?action=parse&page=annecy&prop=sections

	-> parsed text + internal links within a specific section
	https://en.wikipedia.org/w/api.php?action=parse&page=annecy&prop=links|text&section=0

	https://en.wikipedia.org/w/api.php?action=parse&page=Annecy&prop=text&section=0

	-> all the external links within an article
	https://en.wikipedia.org/w/api.php?action=parse&page=annecy&prop=externallinks

	-> get the wikibase_item of an article
	https://en.wikipedia.org/w/api.php?action=query&prop=pageprops&ppprop=wikibase_item&titles=Annecy
	https://en.wikipedia.org/w/api.php?action=query&prop=pageprops&ppprop=wikibase_item&titles=Annecy&formatversion=2


	==========
	wikidata

	-> get the statements from an item
	https://www.wikidata.org/w/api.php?action=wbgetclaims&format=xml&props=value&entity=Q50189


	-> get the labels of a series of article in English and French
	https://www.wikidata.org/w/api.php?action=wbgetentities&props=labels&format=xml&languages=en|fr&ids=Q50189|Q544|Q3241540|Q185969|Q715269|Q27527


	-> the description of a property
	https://www.wikidata.org/wiki/Property:P214
	

	-> querying if Annecy (Q50189) has the country property (P17)
	https://www.wikidata.org/w/api.php?action=wbgetclaims&entity=Q50189&property=P17 


	-> freebase identifier
	https://www.wikidata.org/wiki/Property:P646
	https://www.freebase.com/m/02jsr9
	

	*/


	function WikiObj(){
		this.sectionNumber;
		this.sections;
		this.sectionLinks = new Array();
		this.sectionLinksWikibase = new Array();

		this.list_Wikibase_item = new Array();
		this.list_Wikibase_statements = new Array();

		this.lang = "fr"
		this.article = "Annecy"
	}
	

	// https://en.wikipedia.org/w/api.php?action=parse&page=annecy&prop=sections


	WikiObj.prototype.generateDataObj = function(){
		this.getHeadings();
	}


	WikiObj.prototype.getHeadings = function(){

		var WObj = this
		// console.log(WObj);

		$.getJSON('http://'+WObj.lang+'.wikipedia.org/w/api.php?action=parse&format=json&callback=?', {
			page:WObj.article, 
			prop:'sections'
		})
			.done(function(result){


				// console.log(result)


				WObj.sections = new Array();

				// $('#json').text(JSON.stringify(result, '', 2));

				// retrieving only the section list
				var sections_in_article = result.parse.sections


				// iterating through the sections
				for(var section in sections_in_article){
					// console.log(sections_in_article[section].line +" : "+sections_in_article[section].level)

					// if (sections_in_article[section].level == 2){
						WObj.sections.push(sections_in_article[section])
					// }
					
				}

				WObj.sections.unshift({'extract': true})
				WObj.sectionNumber = WObj.sections.length 

				// console.table(WObj.sections); 

				WObj.getInteralLinks();
			});
	
	};


	WikiObj.prototype.getInteralLinks = function(){

		var WObj = this
		console.log(WObj);
		console.log(WObj.sectionNumber);

		var currentSection = 0;
		var sectionsTotal = WObj.sectionNumber

		query_internal_links_in_section = function(sectionRef){

			// console.log('Querying links from section '+sectionRef)

			$.getJSON('http://'+WObj.lang+'.wikipedia.org/w/api.php?action=parse&format=json&callback=?', {
				page:WObj.article, 
				prop:'links',
				section: sectionRef
			})

			.done(function(result){

				// console.log(result);
				// console.log(sectionRef);

				var links_in_section = result.parse.links

				WObj.sectionLinks[sectionRef] = new Array();

				arrayLinks = WObj.sectionLinks[sectionRef] 

				for(var link in links_in_section){
					// console.log(links_in_section[link])
					arrayLinks.push(links_in_section[link]["*"])
				}

				// console.log(arrayLinks)

				if(currentSection < sectionsTotal - 1){
					currentSection++;
					query_internal_links_in_section(currentSection);
				}else{
					console.log("ende: getInteralLinks");
					// console.table(arrayLinks);
					WObj.getWikibase_item()
				}
			});
		};

		query_internal_links_in_section(0);
	};

	WikiObj.prototype.getWikibase_item = function(){

		console.log('getting wikibase_item')
		var WObj = this

		var currentSection = 0;
		var sectionsTotal = WObj.sectionNumber

		query_wikibase_items_in_section = function(sectionRef){
			console.log('///////////////////////////////////////////');

			console.log('searching for wikibase_items in section: '+sectionRef)

			var chunkedArray = _.chunk(WObj.sectionLinks[sectionRef], 50);
			// console.log(WObj.sectionLinks[sectionRef])
			// console.log(chunkedArray)

			// console.log(chunkedArray.length)

			WObj.sectionLinksWikibase[sectionRef] = new Array();

			var sectionsChunkTotal = chunkedArray.length
			var currentChunkSection = 0;

			query_chunk = function(chunkRef){

				var chunkedString = _.join(chunkedArray[chunkRef], '|');
				console.log(chunkedString)

				$.getJSON('http://'+WObj.lang+'.wikipedia.org/w/api.php?action=query&format=json&callback=?', {
					prop:'pageprops', // |redirects
					ppprop:'wikibase_item',
					titles:chunkedString, 
					formatversion:2,
					redirects:true
				})

				.done(function(result){

					console.log(result)


					// if(result.query.pages !== undefined){
					if(typeof result.query != "undefined"){

						var pages = result.query.pages
						console.log(pages)
						WObj.sectionLinksWikibase[sectionRef].push(pages)
					}

					if(currentChunkSection < sectionsChunkTotal - 1){
						currentChunkSection++;
						query_chunk(currentChunkSection);
						console.log('next!: '+currentChunkSection)

					}else{
						console.log("ende: query_chunk "+ chunkRef);
						// console.table(arrayLinks);
						// console.log(_.flatten(WObj.sectionLinksWikibase[sectionRef]))
						WObj.sectionLinksWikibase[sectionRef] = _.flatten(WObj.sectionLinksWikibase[sectionRef])


						//

						if(currentSection < sectionsTotal - 1){
							currentSection++;
							query_wikibase_items_in_section(currentSection);
						}else{
							console.log("ende: query_wikibase_items_in_section");

							WObj.getWikibase_statements();

							
						}
					}	
				});
			}
			query_chunk(0);
			// links from the top?
		}
		query_wikibase_items_in_section(0);
	}

	WikiObj.prototype.getWikibase_statements = function () {

		console.log('getWikibase_statements')
		var WObj = this


		var tmpArray = new Array();

		tmpArray = _.flatten(WObj.sectionLinksWikibase)
		
		// WObj.list_Wikibase_item

		console.log(tmpArray)

		for (var item in tmpArray) {
			// console.log(tmpArray[item])
			var elem = tmpArray[item]

			if(elem.pageprops){
				console.log(elem.pageprops.wikibase_item)
				// WObj.list_Wikibase_item.push(Number(elem.pageprops.wikibase_item.substring(1)))
				WObj.list_Wikibase_item.push(elem.pageprops.wikibase_item)
			}

			WObj.list_Wikibase_item = _.uniq(WObj.list_Wikibase_item)
		}

		var chunkedArray = _.chunk(WObj.list_Wikibase_item, 50);

		console.log(chunkedArray)

		var sectionsChunkTotal = chunkedArray.length
		var currentChunkSection = 0;

		query_chunk = function(chunkRef){

			console.log(chunkedArray[chunkRef])

			var url = wdk.getEntities({
				ids: chunkedArray[chunkRef]
			})

			console.log(wdk)

			$.ajax({
			    dataType: "jsonp",
			    url : url,
			    // timeout : 15000
			})

			.done(function(data) {
				console.log(data)

				for (var item in data.entities) {
					var entity = data.entities[item]
					entity.claims = wdk.simplifyClaims(entity.claims)

					console.log(data.entities[item].id);
					console.log(entity.claims)

					// WObj.list_Wikibase_statements[data.entities[item].id] = entity.claims

					var tmpObj = new Object();
					tmpObj.id = data.entities[item].id
					tmpObj.claims = entity.claims

					WObj.list_Wikibase_statements.push(tmpObj)
				};

				if(currentChunkSection < sectionsChunkTotal - 1){
					currentChunkSection++;
					query_chunk(currentChunkSection);
				}else{
					console.log("statements retrieved");	

					WObj.exportJSON();			
				}


		    })

		    .fail(function() { 
		    	console.log("error"); 
		    });
		}

		query_chunk(0);
	}

	WikiObj.prototype.exportJSON = function () {

		console.log('exporting a JSON')
		var WObj = this


		// exporting statements

		var exportObject = new Object();

		console.log(this.list_Wikibase_statements)

		exportObject.statements = this.list_Wikibase_statements
		exportObject.sections = this.sections
		exportObject.sectionNumber = this.sectionNumber
		exportObject.sectionLinksWikibase = this.sectionLinksWikibase

		var jsonString = JSON.stringify(exportObject);

		console.log(jsonString);

	}

var wikiObj1 = new WikiObj();

wikiObj1.generateDataObj();

})();
</script>
 
</body>
</html>


